<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta de Abarrotes</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .product-card:hover .delete-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- Modal para Agregar Producto -->
    <div id="addProductModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Agregar Nuevo Producto</h2>
            <input type="text" id="newProductName" placeholder="Nombre del Producto" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="number" id="newProductPrice" placeholder="Precio (ej: 15.50)" step="0.01" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('addProductModal')" class="px-5 py-2 text-gray-600 bg-gray-200 rounded-xl hover:bg-gray-300 font-medium">Cancelar</button>
                <button onclick="saveNewProduct()" class="px-5 py-2 text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 font-medium shadow-md">Guardar Producto</button>
            </div>
        </div>
    </div>

    <!-- Modal para Reporte Diario / Corte -->
    <div id="reportModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl h-5/6 flex flex-col">
            <h2 class="text-3xl font-extrabold mb-4 text-indigo-700">Reporte de Corte</h2>
            <p id="report-date-info" class="text-sm text-gray-500 mb-4"></p>
            <div id="report-loading" class="text-center p-8 hidden">
                <div class="w-12 h-12 border-4 border-indigo-400 border-t-indigo-700 rounded-full animate-spin mx-auto"></div>
                <p class="mt-2 text-indigo-600">Cargando ventas desde la nube...</p>
            </div>

            <div id="report-content" class="flex-grow overflow-y-auto mb-6 p-2 border border-gray-200 rounded-lg">
                <!-- El reporte de ventas se inyectará aquí -->
            </div>
            
            <div id="report-summary" class="bg-indigo-50 p-4 rounded-lg shadow-inner mt-4">
                <p class="text-lg font-semibold text-gray-700">Resumen de Ventas:</p>
                <p class="text-4xl font-extrabold text-indigo-600 mt-1" id="total-revenue">$0.00</p>
                <p class="text-sm text-gray-600 mt-2">Ventas pendientes de corte: <span id="sales-count" class="font-bold">0</span></p>
            </div>

            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                <button onclick="downloadReport()" class="px-4 py-2 text-sm text-indigo-600 bg-indigo-100 rounded-xl hover:bg-indigo-200 font-medium transition duration-150">
                    Descargar Reporte (CSV)
                </button>
                <div class="space-x-3 flex">
                    <button onclick="closeModal('reportModal')" class="px-5 py-2 text-gray-600 bg-gray-200 rounded-xl hover:bg-gray-300 font-medium shadow-md">Cerrar</button>
                    <button id="closeCutBtn" onclick="closeDailyCut()" class="px-5 py-2 text-white bg-green-600 rounded-xl hover:bg-green-700 font-bold shadow-lg transition duration-150">
                        Realizar y Cerrar Corte
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Notificación/Alerta -->
    <div id="alertModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs text-center">
            <h3 id="alertTitle" class="text-xl font-bold mb-3 text-gray-800">¡Éxito!</h3>
            <p id="alertMessage" class="text-gray-600 mb-4">El producto fue añadido.</p>
            <button onclick="closeModal('alertModal')" class="px-4 py-2 text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 font-medium">Aceptar</button>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="confirmTitle" class="text-xl font-bold mb-3 text-red-600">Confirmar Eliminación</h3>
            <p id="confirmMessage" class="text-gray-700 mb-6">¿Estás seguro de que deseas eliminar este producto?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancel" onclick="closeModal('confirmModal')" class="px-5 py-2 text-gray-600 bg-gray-200 rounded-xl hover:bg-gray-300 font-medium">Cancelar</button>
                <button id="confirmAction" class="px-5 py-2 text-white bg-red-600 rounded-xl hover:bg-red-700 font-medium shadow-md">Eliminar</button>
            </div>
        </div>
    </div>


    <!-- ESTRUCTURA PRINCIPAL -->
    <div class="flex flex-col md:flex-row gap-8 max-w-screen-xl mx-auto">
        
        <!-- Columna de Productos (Catálogo) -->
        <div class="w-full md:w-2/3 bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-extrabold text-gray-800">Catálogo de Productos</h1>
                <div class="space-x-3">
                    <button onclick="openModal('addProductModal')" class="px-5 py-2 text-white bg-green-500 rounded-xl hover:bg-green-600 font-semibold shadow-md transition duration-150">
                        + Agregar Producto
                    </button>
                    <button onclick="showReport()" class="px-5 py-2 text-indigo-700 bg-indigo-100 rounded-xl hover:bg-indigo-200 font-semibold shadow-md transition duration-150">
                        Corte Diario
                    </button>
                </div>
            </div>

            <!-- Listado de Productos -->
            <div id="product-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto max-h-[70vh] pr-2">
                <!-- Las tarjetas de producto se renderizan aquí -->
                <div class="text-center py-12 text-gray-500" id="loading-catalog">
                    <div class="w-8 h-8 border-4 border-indigo-400 border-t-indigo-700 rounded-full animate-spin mx-auto"></div>
                    <p class="mt-2">Cargando catálogo...</p>
                </div>
            </div>
        </div>
        
        <!-- Columna de Carrito y Total -->
        <div class="w-full md:w-1/3 bg-white p-6 rounded-2xl shadow-lg border border-gray-100 sticky top-4 self-start">
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-indigo-700">Carrito de Compra</h2>
            
            <!-- Items del Carrito -->
            <div id="cart-items" class="min-h-[150px] max-h-[40vh] overflow-y-auto mb-6 border p-2 rounded-lg bg-gray-50">
                <p id="empty-cart-message" class="text-gray-500 text-center py-10">El carrito está vacío.</p>
                <!-- Los elementos del carrito se inyectan aquí -->
            </div>
            
            <!-- Resumen de Totales -->
            <div class="space-y-3 pt-4 border-t">
                <div class="flex justify-between text-2xl font-bold text-gray-800">
                    <span>Total:</span>
                    <span id="cart-total">$0.00</span>
                </div>
                <div class="flex flex-col">
                    <label for="payment-input" class="text-sm font-medium text-gray-600">Paga con:</label>
                    <input type="number" id="payment-input" placeholder="$0.00" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                </div>
                <div class="flex justify-between text-xl font-bold text-green-600">
                    <span>Cambio:</span>
                    <span id="cart-change">$0.00</span>
                </div>
            </div>
            
            <!-- Botones de Acción -->
            <div class="mt-8 space-y-3">
                <button id="checkout-btn" onclick="handleCheckout()" disabled class="w-full p-4 text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 font-extrabold text-xl shadow-lg transition duration-150 disabled:bg-indigo-300">
                    Cobrar
                </button>
                <button onclick="clearCart()" class="w-full p-3 text-indigo-600 bg-indigo-100 rounded-xl hover:bg-indigo-200 font-semibold transition duration-150">
                    Vaciar Carrito
                </button>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script type="module">
        // --- IMPORTACIONES DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Habilitar logs para depuración

        // Declaración global de variables de Firebase y App
        let app;
        let db;
        let auth;
        let userId;
        let cart = [];
        let products = []; // Catálogo de productos
        
        // --- ⚠️ CONFIGURACIÓN CRÍTICA DE FIREBASE ⚠️ ---
        // DEBES reemplazar el contenido de FIREBASE_CONFIG con TUS 6 CLAVES REALES de tu consola de Firebase.
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCiSLvBgT5OSJItC_33jb9VKrttsn3zlT0", 
            authDomain: "mi-abarrotera-pos1234.firebaseapp.com",
            projectId: "mi-abarrotera-pos1234", 
            storageBucket: "mi-abarrotera-pos1234.firebasestorage.app",
            messagingSenderId: "203517262925",
            appId: "1:203517262925:web:c80e45d1c9602e4ce63004",
        };
        
        // Usa la configuración real para Netlify
        const firebaseConfig = FIREBASE_CONFIG;
        
        // ID para separar los datos de esta aplicación de otras
        const appId = 'punto-de-venta-abarrotes-v1'; 

        // ----------------------------------------------------------------------
        // 1. INICIALIZACIÓN DE FIREBASE Y AUTENTICACIÓN
        // ----------------------------------------------------------------------

        async function initializeFirebase() {
            try {
                // 1. Inicializa la aplicación y los servicios
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Autenticación (se usa signInAnonymously para apps simples)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 3. Obtener el ID del usuario
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // 4. Inicia la escucha del catálogo
                startCatalogListener();

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showModal('alertModal', 'Error Grave', 'No se pudo conectar a la base de datos. Verifica la configuración de Firebase.');
                document.getElementById('loading-catalog').innerHTML = `<p class="text-red-500">Error de conexión. Revisa la consola y tus credenciales.</p>`;
            }
        }
        
        // Función para obtener la referencia de la colección de ventas (PÚBLICA)
        function getSalesCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/sales`);
        }
        
        // Función para obtener la referencia de la colección de catálogo (PÚBLICA)
        function getCatalogCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/catalog`);
        }

        // ----------------------------------------------------------------------
        // 2. GESTIÓN DE CATÁLOGO (Persistencia)
        // ----------------------------------------------------------------------

        // Productos de muestra para poblar el catálogo la primera vez
        const initialProducts = [
            { id: crypto.randomUUID(), name: 'Refresco Cola (600ml)', price: 18.50 },
            { id: crypto.randomUUID(), name: 'Jugo de Naranja (500ml)', price: 15.00 },
            { id: crypto.randomUUID(), name: 'Bolsa de Frituras Grande', price: 25.00 },
            { id: crypto.randomUUID(), name: 'Huevo (Docena)', price: 45.00 },
            { id: crypto.randomUUID(), name: 'Leche Entera (1L)', price: 24.00 },
            { id: crypto.randomUUID(), name: 'Pan de Caja (Grande)', price: 40.00 },
            { id: crypto.randomUUID(), name: 'Agua Embotellada (1L)', price: 12.00 },
            { id: crypto.randomUUID(), name: 'Lata de Atún', price: 16.50 },
            { id: crypto.randomUUID(), name: 'Chocolate en Barra', price: 8.00 },
            { id: crypto.randomUUID(), name: 'Café Soluble (100g)', price: 55.00 },
        ];
        
        // Escucha en tiempo real del catálogo
        function startCatalogListener() {
            const catalogRef = getCatalogCollectionRef();
            
            onSnapshot(catalogRef, async (snapshot) => {
                const loadingIndicator = document.getElementById('loading-catalog');
                
                // Verifica si la colección está vacía. Si es así, la poblamos por primera vez.
                if (snapshot.empty && products.length === 0) {
                    loadingIndicator.innerHTML = `<p class="mt-2 text-indigo-600">Catálogo vacío. Cargando productos iniciales...</p>`;
                    await populateInitialCatalog();
                    return;
                }
                
                // Si ya hay datos o se poblaron, actualiza la lista local
                products = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    dbId: doc.id // Guarda el ID de Firestore para eliminar/actualizar
                }));
                
                renderProductList();
            }, (error) => {
                console.error("Error al escuchar el catálogo:", error);
                document.getElementById('loading-catalog').innerHTML = `<p class="text-red-500">Error al cargar el catálogo.</p>`;
            });
        }
        
        // Función para poblar el catálogo la primera vez
        async function populateInitialCatalog() {
            const catalogRef = getCatalogCollectionRef();
            for (const product of initialProducts) {
                // Usar addDoc para dejar que Firestore genere el ID, o setDoc si quisiéramos usar product.id como el ID del documento
                await addDoc(catalogRef, product); 
            }
        }

        // Función para guardar un nuevo producto en Firestore
        async function saveNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);

            if (!name || isNaN(price) || price <= 0) {
                showModal('alertModal', 'Error', 'Por favor, introduce un nombre y un precio válido.', 'bg-red-500');
                return;
            }
            
            closeModal('addProductModal');

            try {
                const newProduct = {
                    id: crypto.randomUUID(), // ID local (no estrictamente necesario si usamos dbId)
                    name: name,
                    price: price,
                    created_at: new Date()
                };

                await addDoc(getCatalogCollectionRef(), newProduct);
                
                // Limpia los campos
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';

                showModal('alertModal', '¡Éxito!', `El producto "${name}" se ha guardado en la nube.`, 'bg-green-500');
            } catch (error) {
                console.error("Error al guardar producto:", error);
                showModal('alertModal', 'Error', 'No se pudo guardar el producto en la nube.', 'bg-red-500');
            }
        }

        // Función para eliminar un producto de Firestore
        function deleteProduct(dbId, productName) {
            // Configurar y mostrar el modal de confirmación
            showModal('confirmModal');
            document.getElementById('confirmTitle').textContent = `Eliminar ${productName}`;
            document.getElementById('confirmMessage').textContent = `¿Estás seguro de que deseas eliminar permanentemente "${productName}" del catálogo?`;

            const confirmActionBtn = document.getElementById('confirmAction');
            const newConfirmAction = confirmActionBtn.cloneNode(true);
            confirmActionBtn.parentNode.replaceChild(newConfirmAction, confirmActionBtn);

            newConfirmAction.onclick = async () => {
                try {
                    closeModal('confirmModal');
                    const productDocRef = doc(db, `artifacts/${appId}/public/data/catalog/${dbId}`);
                    await deleteDoc(productDocRef);
                    showModal('alertModal', '¡Eliminado!', `"${productName}" fue eliminado correctamente.`, 'bg-red-500');
                } catch (error) {
                    console.error("Error al eliminar producto:", error);
                    showModal('alertModal', 'Error', 'No se pudo eliminar el producto.', 'bg-red-500');
                }
            };
        }

        // Renderiza el catálogo de productos
        function renderProductList() {
            const productListDiv = document.getElementById('product-list');
            productListDiv.innerHTML = '';
            
            if (products.length === 0) {
                productListDiv.innerHTML = `<p class="col-span-4 text-center py-12 text-gray-500">No hay productos en el catálogo. ¡Agrega uno!</p>`;
                return;
            }

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-sm hover:bg-white hover:shadow-lg transition duration-200 flex flex-col justify-between';
                card.onclick = () => addToCart(product);

                card.innerHTML = `
                    <div class="text-right delete-btn absolute top-2 right-2">
                        <button onclick="event.stopPropagation(); deleteProduct('${product.dbId}', '${product.name}')" class="text-red-500 hover:text-red-700 bg-white rounded-full p-1 shadow-md" title="Eliminar Producto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div class="mt-2">
                        <p class="text-sm font-semibold text-gray-700">${product.name}</p>
                        <p class="text-2xl font-extrabold text-indigo-600 mt-2">$${product.price.toFixed(2)}</p>
                    </div>
                `;
                productListDiv.appendChild(card);
            });
            // Esconder indicador de carga
            const loadingIndicator = document.getElementById('loading-catalog');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }


        // ----------------------------------------------------------------------
        // 3. GESTIÓN DE CARRITO (Lógica local)
        // ----------------------------------------------------------------------

        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            renderCart();
        }

        function removeFromCart(productId) {
            const index = cart.findIndex(item => item.id === productId);
            if (index > -1) {
                cart.splice(index, 1);
            }
            renderCart();
        }
        
        function changeQuantity(productId, delta) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity += delta;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    renderCart();
                }
            }
        }

        function clearCart() {
            cart = [];
            document.getElementById('payment-input').value = '';
            renderCart();
        }

        function calculateTotals() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const payment = parseFloat(document.getElementById('payment-input').value) || 0;
            const change = payment > total ? payment - total : 0;
            
            document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
            document.getElementById('cart-change').textContent = `$${change.toFixed(2)}`;

            const checkoutBtn = document.getElementById('checkout-btn');
            if (total > 0 && payment >= total) {
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = `Cobrar $${total.toFixed(2)}`;
            } else {
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Cobrar';
            }
            
            return { total, payment, change };
        }

        function renderCart() {
            const cartItemsDiv = document.getElementById('cart-items');
            cartItemsDiv.innerHTML = '';

            if (cart.length === 0) {
                document.getElementById('empty-cart-message').style.display = 'block';
                document.getElementById('cart-items').appendChild(document.getElementById('empty-cart-message'));
            } else {
                document.getElementById('empty-cart-message').style.display = 'none';
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between p-2 mb-2 bg-white rounded-lg shadow-sm';
                    itemDiv.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-sm font-medium text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500">$${item.price.toFixed(2)} c/u</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="changeQuantity('${item.id}', -1)" class="text-gray-600 hover:text-red-600">-</button>
                            <span class="font-bold text-gray-800">${item.quantity}</span>
                            <button onclick="changeQuantity('${item.id}', 1)" class="text-gray-600 hover:text-green-600">+</button>
                            <span class="w-16 text-right font-semibold text-indigo-600">$${itemTotal.toFixed(2)}</span>
                        </div>
                    `;
                    cartItemsDiv.appendChild(itemDiv);
                });
            }
            calculateTotals();
        }

        // ----------------------------------------------------------------------
        // 4. CHECKOUT Y PERSISTENCIA DE VENTAS (Firestore)
        // ----------------------------------------------------------------------

        async function handleCheckout() {
            const { total, payment, change } = calculateTotals();
            
            if (cart.length === 0 || total <= 0) {
                showModal('alertModal', 'Error', 'El carrito está vacío.', 'bg-red-500');
                return;
            }
            
            if (payment < total) {
                showModal('alertModal', 'Error', 'El pago es insuficiente para cubrir el total.', 'bg-red-500');
                return;
            }

            try {
                // Crear el objeto de venta
                const saleData = {
                    timestamp: new Date().toISOString(),
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    subtotal: total,
                    total: total,
                    payment: payment,
                    change: change,
                    processed_by: userId,
                    cut_date: null, // Campo para marcar si ya fue incluido en un corte
                };
                
                // Guardar la venta en Firestore
                await addDoc(getSalesCollectionRef(), saleData);

                // Mostrar éxito y limpiar
                showModal('alertModal', '¡Venta Exitosa!', `Total: $${total.toFixed(2)}. Su cambio: $${change.toFixed(2)}`, 'bg-green-500');
                clearCart();
                document.getElementById('payment-input').value = '';

            } catch (error) {
                console.error("Error al guardar venta:", error);
                showModal('alertModal', 'Error Grave', 'No se pudo guardar la venta en la nube.', 'bg-red-500');
            }
        }

        // ----------------------------------------------------------------------
        // 5. REPORTE Y CORTE DIARIO (Firestore)
        // ----------------------------------------------------------------------

        async function showReport() {
            openModal('reportModal');
            document.getElementById('report-loading').style.display = 'block';
            document.getElementById('report-content').innerHTML = '';
            document.getElementById('report-summary').style.display = 'none';

            try {
                // Consultar solo las ventas que NO tienen fecha de corte (cut_date == null)
                const salesQuery = query(getSalesCollectionRef(), where("cut_date", "==", null));
                const snapshot = await getDocs(salesQuery);

                const salesToReport = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderReport(salesToReport);
                
            } catch (error) {
                console.error("Error al cargar el reporte:", error);
                document.getElementById('report-content').innerHTML = `<p class="text-red-500">Error al cargar el reporte desde la nube.</p>`;
            } finally {
                document.getElementById('report-loading').style.display = 'none';
                document.getElementById('report-summary').style.display = 'block';
            }
        }

        function renderReport(sales) {
            const reportContentDiv = document.getElementById('report-content');
            let totalRevenue = 0;

            if (sales.length === 0) {
                reportContentDiv.innerHTML = `<p class="text-gray-500 text-center py-10">No hay ventas pendientes para el corte.</p>`;
                document.getElementById('closeCutBtn').disabled = true;
                document.getElementById('closeCutBtn').textContent = 'Corte Cerrado';
                document.getElementById('total-revenue').textContent = '$0.00';
                document.getElementById('sales-count').textContent = '0';
                return;
            }

            document.getElementById('closeCutBtn').disabled = false;
            document.getElementById('closeCutBtn').textContent = 'Realizar y Cerrar Corte';

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            sales.forEach(sale => {
                totalRevenue += sale.total;
                const saleTime = new Date(sale.timestamp).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                const itemsList = sale.items.map(item => `${item.name} (${item.quantity})`).join(', ');

                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${saleTime}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${itemsList}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-indigo-600">$${sale.total.toFixed(2)}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            
            reportContentDiv.innerHTML = tableHTML;
            document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('sales-count').textContent = sales.length;
        }

        async function closeDailyCut() {
            const salesQuery = query(getSalesCollectionRef(), where("cut_date", "==", null));
            const snapshot = await getDocs(salesQuery);
            
            if (snapshot.empty) {
                showModal('alertModal', 'Aviso', 'No hay ventas pendientes de corte.', 'bg-yellow-500');
                return;
            }

            const cutTime = new Date().toISOString();
            const batch = db.batch(); // Usamos un batch para actualizar todo de una vez

            snapshot.docs.forEach(doc => {
                const saleRef = doc.ref;
                // Actualiza la venta para marcar la fecha del corte
                batch.update(saleRef, { cut_date: cutTime });
            });

            try {
                await batch.commit();
                closeModal('reportModal');
                showModal('alertModal', '¡Corte Exitoso!', `Se cerró el corte con ${snapshot.size} ventas.`, 'bg-green-600');
            } catch (error) {
                console.error("Error al cerrar el corte:", error);
                showModal('alertModal', 'Error', 'No se pudo cerrar el corte en la nube.', 'bg-red-500');
            }
        }

        function downloadReport() {
            // Re-ejecutar la lógica de reporte para obtener solo las ventas NO cortadas (aunque ya están en la vista)
            const table = document.getElementById('report-content').querySelector('table');
            if (!table) {
                showModal('alertModal', 'Aviso', 'No hay datos para descargar.', 'bg-yellow-500');
                return;
            }

            let csv = "Hora,Productos,Total\n";
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                const time = cols[0].textContent;
                const products = cols[1].textContent.replace(/,/g, ';'); // Reemplaza comas internas para no romper el CSV
                const total = cols[2].textContent.replace('$', '');
                csv += `${time},"${products}",${total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `Corte_Diario_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ----------------------------------------------------------------------
        // 6. GESTIÓN DE MODALES
        // ----------------------------------------------------------------------

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }
        
        // Función general para mostrar modales de alerta
        function showModal(id, title, message, colorClass = 'bg-indigo-600') {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            
            const acceptBtn = document.querySelector(`#${id} button`);
            acceptBtn.className = `px-4 py-2 text-white ${colorClass} rounded-xl hover:bg-opacity-90 font-medium`;
            
            openModal(id);
        }


        // ----------------------------------------------------------------------
        // INICIO DE LA APLICACIÓN
        // ----------------------------------------------------------------------

        // Event listener para calcular cambio al cambiar el valor de pago
        document.getElementById('payment-input').addEventListener('input', calculateTotals);
        
        // Inicializa Firebase al cargar la página
        window.onload = initializeFirebase;
        // Renderiza el carrito inicialmente
        renderCart();

    </script>
</body>
</html>
